<root BTCPP_format="4">
  <BehaviorTree ID="TransportMaterials">

    <Sequence ID="root_sequence">

      <!-- 1. Check if everything is already in the correct place -->
      <CheckAllDelivered ID="check_all_delivered"
                         out_needs_transport="{needs_transport}" />

      <ReactiveFallback ID="transport_fallback">

        <!-- If nothing left to transport â†’ success -->
        <Condition ID="nothing_to_do" condition="{needs_transport} == false" />

        <!-- Otherwise continue transport cycle -->
        <Sequence ID="transport_cycle">

          <!-- 2. Ensure MiR has slots or unload first -->
          <CheckFreeSlots ID="check_slots"
                          out_slots_free="{slots_free}" />

          <ReactiveFallback ID="slots_fallback">

            <!-- If no free slots, go unload at Opentrons -->
            <Sequence ID="unload_cycle">
              <GoToMission ID="go_to_opentrons"
                           action_name="go_to_mission"
                           mission_id="a5c110d4-a4f7-11f0-b2e5-000e8e984489" />
              <UnloadAllMaterials ID="unload_all"
                                  action_name="Place"
                                  current_slot="{current_slot}" />
            </Sequence>

            <!-- If slots available, continue normal pickup sequence -->
            <Sequence ID="pickup_cycle">

              <!-- 3. Select next material -->
              <MaterialManager ID="select_material"
                               out_material="{current_material}" />

              <!-- 4. Determine where to pick that material up -->
              <StorageSelector ID="select_storage"
                               material="{current_material}"
                               out_storage_mission="{target_storage_mission}" />

              <!-- 5. Go to correct storage -->
              <GoToMission ID="go_to_material_storage"
                           action_name="go_to_mission"
                           mission_id="{target_storage_mission}" />

              <!-- 6. Pick up the material using Franka -->
              <Franka ID="pickup_material"
                      action_name="Pickup"
                      ContainerName="{current_material}" />

            </Sequence>

          </ReactiveFallback>

          <!-- This dummy condition forces the Sequence to continue looping -->
          <Condition ID="continue_transport" condition="true" />

        </Sequence>

      </ReactiveFallback>

      <!-- 7. Once all cycles done and materials delivered, go home -->
      <GoToMission ID="go_to_home"
                   action_name="go_to_mission"
                   mission_id="76638485-a4f7-11f0-b2e5-000e8e984489" />

    </Sequence>

  </BehaviorTree>
</root>
